<!DOCTYPE html>

<html>

<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
    <title>Barcode</title>
</head>

<body>

    <div class="flex-container">
        <div id="form-input" class="panel">
            <h1>Barcode</h1>

            <form id="form-create" method="post">
                <select id="code-select" name="code" class="form-row" aria-label="Barcode Type" required>
                    <option value="" disabled selected hidden>*Select a Barcode Type</option>
                </select>

                <textarea name="data" rows="10" class="form-row" style="resize: vertical;" placeholder="*Enter barcode text..." required></textarea>

                <input id="name-field" type="text" name="name" class="form-row" aria-label="Name/Description" placeholder="Name/Description" />

                <button type="submit" id="btn-generate" class="form-row">
                    Generate
                </button>

                <button type="reset" id="btn-clear" class="form-row">
                    Clear
                </button>
            </form>

            <hr />
            <select id="session-select" name="session" aria-label="Session">
                <option value="" disabled selected hidden>Select a Session</option>
            </select>
        </div>

        <div id="main-container" class="panel">
            <div id="scratch-pad"></div>
            <div id="help-box">
                <p>Left Click - Drag'n'Drop</p>
                <p>Middle Click - Delete</p>
            </div>
        </div>
    </div>


    <script src="wasm_exec.js"></script>
    <script type="importmap">
        {
            "imports": {
                "api/barcode": "./barcode.js",
                "api/storage": "./storage.js",
                "api/backend": "./backend.js"
            }
        }
    </script>
    <script type="module">
        import { loadSession, sessionSelect, add as addBarcode, renderFunc, renderOnto } from 'api/barcode'
        import 'api/storage' // imported for side-effects
        import { supported_types, request as generateBarcode } from 'api/backend'

        const go = new Go()
        let res = await WebAssembly.instantiateStreaming(fetch('main.wasm'), go.importObject)
        go.run(res.instance)

        const scratch_pad = document.getElementById('scratch-pad')
        const form_create = document.getElementById('form-create')

        renderFunc((e) => {
            scratch_pad.textContent = ''
            renderOnto(scratch_pad)
            if (e === addBarcode) {
                scratch_pad.scrollTop = scratch_pad.scrollHeight
            }
        })

        form_create.addEventListener('reset', function(e) {
            e.preventDefault()
            e.target.data.value = ''
            e.target.name.value = ''
        })

        form_create.addEventListener('submit', function(e) {
            e.preventDefault()

            const b = {
                'type': e.target.code.value,
                'text': e.target.data.value,
                'name': e.target.name.value
            }

            let buf = new Uint8Array(1024*1024*5)
            createBarcode(b.type, b.text, buf)
                .then(_ => {
                    let blob = new Blob([buf], {type: "image/png"})
                    b.url = URL.createObjectURL(blob)
                    addBarcode(b)
                    e.target.reset()
                })
                .catch(alert)
        })

        const select = document.getElementById('code-select')
        supportedTypes()
            .then(JSON.parse)
            .then(types => {
                select.removeChild(select.children[0])
                types.forEach(t => {
                    const opt = document.createElement('option')
                    opt.value = t.Value
                    opt.innerHTML = t.Name
                    select.appendChild(opt)
                })
            })
            .catch(alert)

        const session_select = document.getElementById('session-select')
        sessionSelect(session_select)
        session_select.addEventListener('change', function(e) {
            loadSession(
                session_select.value === 'create_new'
                ? null
                : session_select.value
            )
            sessionSelect(session_select)
        })
        loadSession(sessionStorage.getSession())
    </script>
</body>

</html>
