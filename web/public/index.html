<!DOCTYPE html>

<html>

<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
    <title>Barcode</title>
</head>

<body>

    <div class="flex-container">
        <div id="form-input" class="panel">
            <h1>Barcode</h1>

            <form id="form-create" method="post">
                <select id="code-select" name="code" class="form-row" aria-label="Barcode Type" required>
                    <option value="" disabled selected hidden>*Select a Barcode Type</option>
                </select>

                <textarea name="data" rows="10" class="form-row" style="resize: vertical;" placeholder="*Enter barcode text..." required></textarea>

                <input id="name-field" type="text" name="name" class="form-row" aria-label="Name/Description" placeholder="Name/Description" />

                <button type="submit" id="btn-generate" class="form-row">
                    Generate
                </button>

                <button type="reset" id="btn-clear" class="form-row">
                    Clear
                </button>
            </form>

            <hr />
            <select id="session-select" name="session" aria-label="Session">
                <option value="" disabled selected hidden>Select a Session</option>
            </select>
        </div>

        <div id="scratch-pad" class="panel"></div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "api/barcode": "./barcode.js",
                "api/storage": "./storage.js",
                "api/backend": "./backend.js"
            }
        }
    </script>
    <script type="module">
        import { loadSession, sessionSelect, add as addBarcode, renderFunc, renderOnto } from 'api/barcode'
        import 'api/storage' // imported for side-effects
        import { supported_types, request as generateBarcode } from 'api/backend'

        const scratch_pad = document.getElementById('scratch-pad')
        const form_create = document.getElementById('form-create')

        renderFunc(() => {
            scratch_pad.textContent = ''
            renderOnto(scratch_pad)
        })

        form_create.addEventListener('reset', function(e) {
            e.preventDefault()
            e.target.data.value = ''
            e.target.name.value = ''
        })

        form_create.addEventListener('submit', function(e) {
            e.preventDefault()

            const b = {
                'type': e.target.code.value,
                'text': e.target.data.value,
                'name': e.target.name.value
            }

            generateBarcode(b.type, b.text)
                .then(fetch)
                .then(r => r.blob())
                .then(blob => {
                    // TODO: weird, fix this
                    const fr = new FileReader()
                    fr.addEventListener('load', function() {
                        b.url = fr.result
                        addBarcode(b)
                        e.target.reset()
                    })
                    fr.readAsDataURL(blob)
                })
                .catch(error => {
                    alert(error)
                })
        })

        const select = document.getElementById('code-select')
        supported_types().then(types => {
            select.removeChild(select.children[0])
            types.forEach(t => {
                const opt = document.createElement('option')
                opt.value = t.Value
                opt.innerHTML = t.Name
                select.appendChild(opt)
            })
        })

        const session_select = document.getElementById('session-select')
        sessionSelect(session_select)
        session_select.addEventListener('change', function(e) {
            loadSession(
                session_select.value === 'create_new'
                ? null
                : session_select.value
            )
            sessionSelect(session_select)
        })
        loadSession(sessionStorage.getSession())
    </script>
</body>

</html>
